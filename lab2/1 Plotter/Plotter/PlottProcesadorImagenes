import serial
import time
from PIL import Image

# --- CONFIG ---
image_path = 'C:/Users/UTEC-5695/Desktop/CNC/Manzana.png'
resize_to = None           # None = keep original size
serial_port = "COM11"       # your Arduino port
baud_rate = 9600           # SLOW AND SAFE
# ---------------

# Open serial connection
ser = serial.Serial(serial_port, baud_rate, timeout=1)
time.sleep(5)# give Arduino time to reset

input("Press Enter to start sending image...")  # simple start control

print("Sending image to CNC...")

# Open and process image
img = Image.open(image_path).convert("L")
if resize_to:
    img = img.resize(resize_to)
width, height = img.size
pixels = list(img.getdata())

# Convert grayscale (0–255) → shade levels (0–7)
def shade_from_gray(value):
    return 7 - int(value / 32)  # invert if needed



data_stream = ""
for y in range(height):
    row = [str(shade_from_gray(pixels[y * width + x])) for x in range(width)]
    data_stream += ''.join(row) + '8'  # 8 = newline
data_stream += '9'  # 9 = print end

# --- SEND TO ARDUINO WITH HANDSHAKE ---
for ch in data_stream:
    while True:
        line = ser.readline().decode().strip()
        if line == "1":  # Arduino ready
            break
    time.sleep(0.01)
    ser.write(ch.encode())  # send next command
    print(f"Sent: {ch}")  # optional: see what’s sent

print("Image transmission complete!")
ser.close()
